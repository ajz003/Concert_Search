<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>iConcert | Results</title>
    <link rel="icon" type="image/png" href="assets/images/bumperBG.jpg" sizes="16x16" />
    <link href="https://fonts.googleapis.com/css?family=Baloo+Tammudu" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <script src='assets/javascript/hotels.js'></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXtwNcWQKwMAYBw-2F4T4FRAwWqj39dJE"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&v=3&libraries=geometry"></script>
    <link rel='stylesheet' href='assets/css/search.css'>
</head>

<body>
    <header>
    <div id="headTitle">
        <h1>iConcert</h1>
    </div>
</header>


    <nav class="navbar navbar-expand-lg navbar-dark bg-dark searchBox">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Link</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false">
                        Account
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#">Saved Trips</a>
                    </div>
                </li>
            </ul>
            <form class="form-inline my-2 my-lg-0">
                <input class="form-control mr-sm-2 locationInput bandInput" type="search" placeholder="Search" aria-label="Search">
                <button class="btn btn-outline-success my-2 my-sm-0 submitForm" type="submit">Search</button>
            </form>
        </div>
    </nav>

    <div class='container-fluid' id='map'> </div>
    <button id='shrink'>shrink</button>
    <div class='container' id='results-col'> </div>
    <div class='container' id='info'>
        <button id='back' class='btn btn-primary'>Back to Results</button>
    </div>


    <!--
        ---------------------------------------------------------------------------------------------

        So the footer below is setup, but is just waiting on some text input before it can fully build the itself.

        var for the div to set up the cost formula  - .totalCost

        _____________________________________________________________________________________________
     -->

    <div id="footer" class="row">
        <div class="col-sm-12">
            <div class="totalCost"></div>
        </div>
    </div>


    <!-- </div> -->



    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>

    <script>
        var venueMarkers = []
        var currentVenue = []
        var currentHotels = []
        var hotelCenters = []



        // Causes results to be pushed off screen or come back on
        $('#shrink').click(function () {
            if ($('#shrink').text() === 'shrink') {
                $('.container').css('left', '-508px')
                $('#shrink').css('left', '0')
                $('#shrink').text('grow')
                $('.container-fluid').css('left', '0%')
            }
            else {
                $('.container').css('left', '0')
                $('#shrink').css('left', '508px')
                $('#shrink').text('shrink')
                $('.container-fluid').css('left', '408px')
            }



        })

        // Causes the info page to show
        $(document).on('click', '.concert', function () {
            $('#info').css('z-index', '1000')
            var img = $('<img>')
            img.attr('src', $(this).children('.col-sm-4').children().attr('src')).css('width', '100%')
            $('#info').append(img)

            var row = $(this)
            var title = $('<h3>').text(row.children('.col-sm-8').children('.title').text())
            $('#info').append(title)

            var location = JSON.parse(this.dataset.location)
            hotelSearch(location)

        })


        //Causes the results page to show

        $(document).on('click', '#back', function () {
            $('#info').css('z-index', '-1')
            currentVenue[0].setMap(null)
            for (var i = 0; i < venueMarkers.length; i++) {
                venueMarkers[i].setMap(map);
            }

            for (var i = 0; i < currentHotels.length; i++) {
                currentHotels[i].setMap(null);
            }

            currentVenue.forEach(element => {
                element.setMap(null)
            })

            currentVenue = []
            currentHotels = []
            map.fitBounds(bounds)

            hotelCenters.forEach(element => {
                element.setMap(null)

            })
            hotelCenters = []



        })



        // creates map
        var map = new google.maps.Map(document.getElementById('map'), {
        });

        //creates bounds for maps

        var bounds = new google.maps.LatLngBounds();

        function addMarkers(events) {

            var i = 1
            events.forEach(element => {
                var location = element._embedded.venues[0].location
                var name = element.name
                marker = new google.maps.Marker({
                    position: new google.maps.LatLng(location.latitude, location.longitude),
                    map: map,
                    url: '#' + i
                })
                google.maps.event.addListener(marker, 'click', function () {
                    $([document.documentElement, document.body]).animate({
                        scrollTop: $(".container").offset().top
                    }, 2000);;
                });
                bounds.extend(marker.position);

                venueMarkers.push(marker)
                if (element.dates.start.localTime !== undefined) {
                    var hour = element.dates.start.localTime.slice(0, 2)
                    var min = element.dates.start.localTime.slice(2, 5)
                    if (parseInt(hour) > 12) {
                        hour = parseInt(hour) - 12
                        min += ' PM'
                    }
                    else if (parseInt(hour) === 12) {
                        min += ' PM'
                    }
                    else {
                        min += ' AM'
                    }

                }
                else {
                    var hour = 'TBA'
                    var min = ''
                }



                // Adds results 
                var title = $('<h4>').text(element.name).css('text-align', 'center').addClass('title')
                var date = $('<p>').text('   ' + element.dates.start.localDate + ' at ' + hour + min).addClass('date')
                var venue = $('<p>').text('     ' + element._embedded.venues[0].name)
                if (element.priceRanges === undefined) {
                    var ticketRange = $('<p>').text('Price Not Available')
                }
                else {
                    var ticketRange = $('<p>').text('     ' + element.priceRanges[0].min + '$ - ' + element.priceRanges[0].max + '$')
                }
                var imgDiv = $('<div>').addClass('cropcircle').css('background-image', "url('" + element.images[7].url + "')")
                var row = $('<div>').addClass('row border concert').attr('data-location', JSON.stringify(element._embedded.venues['0'].location))
                var col = $('<div>').addClass('col-sm-8')
                var imgCol = $('<div>').addClass('col-sm-4 d-flex align-items-center').css('height', '111px')
                var calendar = $('<img>').attr('src', "open-iconic-master/svg/calendar.svg")
                var pin = $('<img>').attr('src', 'open-iconic-master/svg/location.svg')
                var dollar = $('<img>').attr('src', 'open-iconic-master/svg/dollar.svg')

                date.prepend(calendar)
                venue.prepend(pin)
                ticketRange.prepend(dollar)
                imgCol.append(imgDiv)

                if (i % 2 === 0) {
                    row.css('background-color', 'lightgrey')
                }
                else {
                    row.css('background-color', 'lemonchiffon')
                }
                col.append(title, date, venue, ticketRange)
                row.append(imgCol, col)
                $('#results-col').append(row)

                row.hover((function (marker, i) {
                    return function () {
                        marker.setAnimation(google.maps.Animation.BOUNCE);
                    }
                })(marker, i), function (marker, i) {
                    return function () {
                        marker.setAnimation(null);
                    }
                }(marker, i));

                i++


            });


            if (events.length <= 2) {
                var location = events[0]._embedded.venues['0'].location
                console.log(location.latitude)
                var myLatLng = { lat: parseFloat(location.latitude), lng: parseFloat(location.longitude) };
                map = new google.maps.Map(document.getElementById('map'), {
                    center: myLatLng,
                    zoom: 11
                });


                events.forEach(element => {
                    var name = element.name
                    var location = element._embedded.venues['0'].location
                    marker = new google.maps.Marker({
                        position: new google.maps.LatLng(location.latitude, location.longitude),
                        map: map
                    })
                    bounds.extend(marker.position);


                })
            }
            else {
                map.fitBounds(bounds)
            }

        }




        //ajax call to google for lat and long of city


        var destination = localStorage.getItem('locationLocal')
        var keyword = localStorage.getItem('band')

        if (destination === 'null') {
            var baseUrl = 'https://app.ticketmaster.com/discovery/v2/events?apikey=yEtBYAcCK5MzWmE1UdE1NUheV74fQK8H&classificationName=Music'
            var queryUrl = baseUrl + '&keyword=' + keyword + '&radius=50'

            $.ajax({
                url: queryUrl,
                method: 'GET'
            }).then(function (response) {

                var events = response._embedded.events

                //sorts events by date
                events.sort(function (a, b) {
                    return Date.parse(a.dates.start.localDate) - Date.parse(b.dates.start.localDate)
                })

                console.log(events)
                var marker
                addMarkers(events)

            })
        }
        else {

            $.ajax({
                url: 'https://maps.googleapis.com/maps/api/geocode/json?address=' + destination + '&key=AIzaSyCXtwNcWQKwMAYBw-2F4T4FRAwWqj39dJE',
                method: 'GET'
            }).then(function (response) {
                var latlong = response.results[0].geometry.location
                var latitude = latlong.lat
                var longitude = latlong.lng
                var baseUrl = 'https://app.ticketmaster.com/discovery/v2/events?apikey=yEtBYAcCK5MzWmE1UdE1NUheV74fQK8H&classificationName=Music'
                var queryUrl = baseUrl + '&keyword=' + keyword + '&radius=50' + '&latlong=' + latitude + ',' + longitude

                console.log(response)
                //ajax call for ticketmaster
                $.ajax({
                    url: queryUrl,
                    method: 'GET'
                }).then(function (response) {

                    var events = response._embedded.events

                    //sorts events by date
                    events.sort(function (a, b) {
                        return Date.parse(a.dates.start.localDate) - Date.parse(b.dates.start.localDate)
                    })

                    console.log(events)
                    var marker
                    addMarkers(events)

                })
            })
        }


    </script>

</body>

</html>