<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>iConcert | Results</title>


    <link rel="icon" type="image/png" href="assets/images/bumperBG.jpg" sizes="16x16" />
    <link href="https://fonts.googleapis.com/css?family=Baloo+Tammudu" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <link rel='stylesheet' href='assets/css/search.css'>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>


    <script src='assets/javascript/hotels.js'></script>
    <script src='assets/javascript/flights.js'></script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXtwNcWQKwMAYBw-2F4T4FRAwWqj39dJE"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXtwNcWQKwMAYBw-2F4T4FRAwWqj39dJE&libraries=geometry"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
        <script src="https://strangecube.com/audioplay2/player/js/audioplay-2.0.0.min.js"></script>


</head>

<body>
    <header>
        <div id="headTitle">
            <h1>iConcert</h1>
        </div>
    </header>

    <!-- 
    __________________________________________________________________________________________________

        So the variables in the form that exists in the navbar are important for pulling information to search with, obviously.

        The query terms are wrapped in the following variables:

        .locationInput
        .bandInput
        .startDateInput
        .endDateInput
         > .submitForm

    ------->


    <nav class="navbar navbar-expand-xl navbar-light bg-transparent searchBox" style='z-index: 1000;'>


        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>


        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="favorite.html">Saved Trips</a>
                </li>
            </ul>
            <form class="form-inline my-2 my-sm-0">
                <input class="form-control mr-sm-2 locationInput" type="search" placeholder="Location" aria-label="Search">
                <input class="form-control mr-sm-2 bandInput" type="search" placeholder="Artist" aria-label="Search">
                <label for="start">Start </label>
                <input type="date" id="start" class="form-control mr-sm-2 startDateInput" name="trip" value="2018-09-10" max="2020-12-31"
                />
                <label for="end">End </label>
                <input type="date" id="end" class="form-control mr-sm-2 endDateInput" name="trip" value="2018-09-11" max="2020-12-31" />
                <button class="btn my-2 my-sm-0 submitForm btn-dark" type="submit">Search</button>
            </form>
        </div>
    </nav>

    <div class='container-fluid' id='map'> </div>
    <button id='shrink'>shrink</button>
    <div class='container' id='results-col'> </div>
    <div class='container' id='info'>
        <div id='buttonsHotel'>
            <button id='backResults' class='btn justify-content-center btn-primary btn-sm'>Back to Results</button>
            <button id='toFlights' class='btn justify-content-center btn-primary btn-sm'>Skip to Flights</button>
        </div>

        <div id="searchDate">
            
     

        <label for="start">Start </label>
        <input type="date" id="startHotel" class="form-control mr-sm-2 startDateInput" name="trip" value="2018-09-10" max="2020-12-31"
        />
        <label for="end">End </label>
        <input type="date" id="endHotel" class="form-control mr-sm-2 endDateInput" name="trip" value="2018-09-11" max="2020-12-31"
        />
        <button id='searchHotel' class="btn my-2 my-sm-0 btn-dark">Search</button>
      </div>


    </div>


    <div class='container' id='flights'>

        <button id='backHotels' class='btn btn-primary btn-sm'>Back to Hotels</button>

        <input type="text" id="startFlight" class="form-control mr-sm-2"/>
       
        <button class="btn my-2 my-sm-0 btn-dark" id='flightSubmit'>Search</button>

    </div>
    <div class='container' id='final'>
        <button id='backFlights' class='btn btn-primary btn-sm'>Back to Flights</button>
        <button id='save' class='btn btn-primary btn-sm'>Save Itinerary!</button>
    </div>
   


    <!--
        ---------------------------------------------------------------------------------------------

        So the footer below is setup, but is just waiting on some text input before it can fully build the itself.

        var for the div to set up the cost formula  - .totalCost

        _____________________________________________________________________________________________
     -->

    <div id="footer" class="row">
        <div class="col-sm">
            <div class="totalCost">
                <h4 id="tC">Total Cost: <span id='sum'></span></h4>
            </div>

        </div>
    </div>


    <!-- </div> -->



    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-firestore.js"></script>

    <!--Gets today's date-->
    <script>
        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth() + 1; //January is 0!
        var yyyy = today.getFullYear();

        if (dd < 10) {
            dd = '0' + dd
        }

        if (mm < 10) {
            mm = '0' + mm
        }

        today = yyyy + '-' + mm + '-' + dd;
        dd2 = dd + 1

        $('#start').val(today)


    </script>


    <script>
        $("#backFlights").click(function(){

        })
        console.log($('.startDateInput').val())
        if (localStorage.getItem('loginId') === null) {
            $('#save').hide()
        }

        // Start Firebase 
        firebase.initializeApp({
            apiKey: 'AIzaSyBuWcwfnrVFPyABm96d6GIoHwwBXa_DAfk',
            authDomain: 'iconcert-638ff.firebaseapp.com',
            projectId: 'iconcert-638ff'
        });

        // Initialize Cloud Firestore through Firebase
        var db = firebase.firestore();

        // Disable deprecated features
        db.settings({
            timestampsInSnapshots: true
        });


        var venueMarkers = []
        var currentVenue = []
        var currentHotels = []
        var hotelCenters = []

        var selectedConcert = ''
        var selectedConcertCity
        var selectedConcertImage
        var selectedHotelPrice
        var selectedFlightPrice
        var keyword
        var hotelStart
        var hotelEnd
        var start
        var end


        var hotelNeighborhood

        var concertLat
        var concertLong

        var minTotal = 0
        var maxTotal = 0
        var locationConcert


        var latitude
        var longitude



        $('#searchHotel').on('click', function (event) {
            event.preventDefault()
            var loadingHotels = $('<h4>').text('Hotels loading, please wait.').attr('id', 'hotelsLoading')
            var loadingimg = $('<img>').attr({
                id: 'loadingGif',
                src: 'https://gifer.com/i/4V0b.gif'
            })
                .css({
                    height: '100px',
                    width: '100px',
                    margin: '0 auto',
                    display: 'block'
                })

            $('#info').append(loadingHotels, loadingimg)

            hotelStart = $('#startHotel').val()
            hotelEnd = $('#endHotel').val()

            hotelStart = new Date(hotelStart)
            hotelEnd = new Date(hotelEnd)
            console.log(hotelStart)

            if (hotelStart.getUTCDate() < 10) {
                var startday = '0' + hotelStart.getUTCDate()
            }
            else {
                var startday = hotelStart.getUTCDate()
            }

            if (hotelStart.getMonth() + 1 < 10) {
                var startmonth = hotelStart.getMonth() + 1
                var startmonth = '0' + startmonth
            }
            else {
                var startmonth = hotelStart.getMonth() + 1
            }
            var startyear = hotelStart.getYear() + 1900



            if (hotelEnd.getUTCDate() < 10) {
                var endday = hotelEnd.getUTCDate()
                endday = '0' + endday
            }
            else {
                var endday = hotelEnd.getUTCDate()
            }

            if (hotelEnd.getMonth() + 1 < 10) {
                var endmonth = hotelEnd.getMonth() + 1
                endmonth = '0' + endmonth
            }
            else {
                var endmonth = hotelEnd.getMonth() + 1
            }
            var endyear = hotelEnd.getYear() + 1900

            start = startmonth + '/' + startday + '/' + startyear
            end = endmonth + '/' + endday + '/' + endyear

    

            flightStart = (parseInt(startday-1)) + '/'+startmonth  + '/' + startyear
            flightEnd =   (parseInt(endday)-1)+'/' + endmonth  + '/' + endyear

            hotelSearch(locationConcert, start, end)

        })

        $(document).on('click', '#save', function () {
            var loginId = localStorage.getItem('loginId')

            var inputRef = db.collection('login').doc(loginId)


            inputRef.get().then(function (doc) {
                if (doc.data().concerts === undefined) {
                    var array = []
                }
                else {
                    var array = doc.data().concerts
                }
                var object = {}
                object.concert = selectedConcert
                object.maxPrice = maxTotal
                object.minPrice = minTotal
                object.imgUrl = selectedConcertImage
                object.hotel = parseFloat(selectedHotelPrice)
                object.flight = selectedFlightPrice
                object.keyword = keyword






                array.push(object)
                var inputRef = db.collection('login').doc(loginId)
                console.log('hi')
                inputRef.set({
                    concerts: array
                }
                )
            })




        })


        // When users click "Submit"
        $(".submitForm").on("click", function (event) {

            // This line prevents the page from refreshing when a user hits "enter".
            event.preventDefault();

            // Grab the user input
            var locationLocal = $(".locationInput").val().trim();
            var band = $(".bandInput").val().trim();
            var startdate = $(".startDateInput").val();
            var enddate = $(".endDateInput").val();

            if (locationLocal === "null") {
                // Clear absolutely everything stored in localStorage using localStorage.clear()

                // Store the location and band into localStorage using "localStorage.setItem"
                localStorage.setItem("band", band);
                console.log(localStorage);
            }

            else {
                // Clear absolutely everything stored in localStorage using localStorage.clear()

                // Store the location and band into localStorage using "localStorage.setItem"
                localStorage.setItem("locationLocal", locationLocal);
                localStorage.setItem("band", band);
                console.log(localStorage);

            }

            // At the end of "on.click", link to another local page
            window.location.href = "search.html";
        });



        // Causes results to be pushed off screen or come back on
        $('#shrink').click(function () {
            if ($('#shrink').text() === 'shrink') {
                $('.container').css('left', '-508px')
                $('#shrink').css('left', '0')
                $('#shrink').text('grow')
                $('.container-fluid').css('left', '0%')
            }
            else {
                $('.container').css('left', '0')
                $('#shrink').css('left', '508px')
                $('#shrink').text('shrink')
                $('.container-fluid').css('left', '408px')
            }



        })

        // Causes the info page to show
        $(document).on('click', '.concert', function () {
            $('#info').css('z-index', '150')

            selectedConcertImage = this.dataset.image
            console.log(selectedConcertImage)

            var row = $(this)
            var date = $('<h5>').text(this.dataset.date).css('margin','0')
            var title = $('<h3>').text(row.children('.col-sm-8').children('.title').text()).css({'text-align': 'center','width':'100%'})
            $('#searchDate').append(title,'<br>',date)



            var loadingHotels = $('<h4>').text('Hotels loading, please wait.').attr('id', 'hotelsLoading')
            var loadingimg = $('<img>').attr({
                id: 'loadingGif',
                src: 'https://gifer.com/i/4V0b.gif'
            })
                .css({
                    height: '100px',
                    width: '100px',
                    margin: '0 auto',
                    display: 'block'
                })

            


            var location = JSON.parse(this.dataset.location)

            hotelSearch(location)



            locationConcert = JSON.parse(this.dataset.location)
            console.log(locationConcert)


            selectedConcert = this.dataset.name
            selectedCity = this.dataset.city


            //update Total cost
            minTotal += parseInt(this.dataset.min)
            maxTotal += parseInt(this.dataset.max)
            $('#sum').text('     $' + minTotal + ' - $' + maxTotal)

        })

        //hotel picked going to flights

        $(document).on('click', '.hotelRow', function () {
            hotelNeighborhood = this.dataset.hood
            selectedHotelPrice = this.dataset.price
            var from = $('#startFlight').val()
            $('#info').css('z-index', '-1')
            $('#flights').css('z-index', '10')
            var flightFrom = $('<input>').attr('id', 'flightFrom');
            minTotal += parseInt(this.dataset.price)
            maxTotal += parseInt(this.dataset.price)
            $('#sum').text('     $' + minTotal + ' - $' + maxTotal)
            hotelCenters.forEach(element => {
                element.setMap(null)

            })


            var flightsLoading = $('<h4>').text('Flights loading, please wait.').attr('id', 'flightsLoading')
            var loadingimg = $('<img>').attr({
                id: 'loadingGif',
                src: 'https://gifer.com/i/4V0b.gif'
            })
                .css({
                    height: '100px',
                    width: '100px',
                    margin: '0 auto',
                    display: 'block'
                })

           
                
        })

        $(document).on('click','#flightSubmit',function(){
            var start = $('#startFlight').val()
            flights(start,flightEnd,flightStart)

        })

        $(document).on('click', '#toFlights', function () {
            $('#info').css('z-index', '-1')
            $('#flights').css('z-index', '10')
            hotelCenters.forEach(element => {
                element.setMap(null)
            })


           var flightFrom =$('#startFlight').val()
            flights(flightFrom,flightEnd,flightStart)

        })


        //Causes the results page to show

        $(document).on('click', '#backResults', function () {
            $('#info').css('z-index', '-1')
            $('#searchDate').children('h3').remove()
            $('#searchDate').children('h5').remove()
            minTotal -= minTotal
            maxTotal -= maxTotal
            $('#sum').text('     $' + minTotal + ' - $' + maxTotal)


            currentVenue[0].setMap(null)
            for (var i = 0; i < venueMarkers.length; i++) {
                venueMarkers[i].setMap(map);
            }

            for (var i = 0; i < currentHotels.length; i++) {
                currentHotels[i].setMap(null);
            }

            currentVenue.forEach(element => {
                element.setMap(null)
            })

            currentVenue = []
            currentHotels = []
            map.fitBounds(bounds)

            hotelCenters.forEach(element => {
                element.setMap(null)

            })
            hotelCenters = []
            



        })

        $(document).on('click', '#backHotels', function () {
            $('#flights').css('z-index', '-1')
            $('#info').css('z-index', '100')

            minTotal -= parseInt(selectedHotelPrice)
            maxTotal -= parseInt(selectedHotelPrice)
            $('#sum').text('     $' + minTotal + ' - $' + maxTotal)

            selectedHotelPrice = 0


            hotelCenters.forEach(element => {
                element.setMap(map)
            })

        })




        // creates map
        var map = new google.maps.Map(document.getElementById('map'), {
        });

        //creates bounds for maps

        var bounds = new google.maps.LatLngBounds();

        function addMarkers(events) {

            var i = 1
            events.forEach(element => {
                var location = element._embedded.venues[0].location
                var city = element._embedded.venues[0].city.name
                var name = element.name
                marker = new google.maps.Marker({
                    position: new google.maps.LatLng(location.latitude, location.longitude),
                    map: map,
                    url: '#' + i
                })
                google.maps.event.addListener(marker, 'click', function () {
                    $([document.documentElement, document.body]).animate({
                        scrollTop: $(".container").offset().top
                    }, 2000);;
                });
                bounds.extend(marker.position);

                venueMarkers.push(marker)
                if (element.dates.start.localTime !== undefined) {
                    var hour = element.dates.start.localTime.slice(0, 2)
                    var min = element.dates.start.localTime.slice(2, 5)
                    if (parseInt(hour) > 12) {
                        hour = parseInt(hour) - 12
                        min += ' PM'
                    }
                    else if (parseInt(hour) === 12) {
                        min += ' PM'
                    }
                    else {
                        min += ' AM'
                    }

                }
                else {
                    var hour = 'TBA'
                    var min = ''
                }



                // Adds results 
                var title = $('<h4>').text(element.name).css('text-align', 'center').addClass('title')
                var date = $('<p>').text('   ' + element.dates.start.localDate + ' at ' + hour + min).addClass('date')
                var venue = $('<p>').text('     ' + element._embedded.venues[0].name + ', ' + city)
                if (element.priceRanges === undefined) {
                    var ticketRange = $('<p>').text('Price Not Available')
                }
                else {
                    var ticketRange = $('<p>').text('     $' + element.priceRanges[0].min + ' - $' + element.priceRanges[0].max)
                }
                var imgDiv = $('<div>').addClass('cropcircle').css('background-image', "url('" + element.images[7].url + "')")


                if (element.priceRanges !== undefined) {
                    var row = $('<div>').addClass('row border concert').attr('data-location', JSON.stringify(element._embedded.venues['0'].location)).attr({
                        'data-name': element.name,
                        'data-min': element.priceRanges[0].min,
                        'data-max': element.priceRanges[0].max,
                        'data-city': element._embedded.venues[0].city.name,
                        'data-image': element.images[7].url,
                        'data-date': element.dates.start.localDate
                    })

                }
                else {
                    var row = $('<div>').addClass('row border concert').attr('data-location', JSON.stringify(element._embedded.venues['0'].location)).attr({
                        'data-name': element.name,
                        'data-min': 0,
                        'data-max': 0,
                        'data-city': element._embedded.venues[0].city.name,
                        'data-image': element.images[7].url,
                        'data-date': element.dates.start.localDate

                    })

                }
                var col = $('<div>').addClass('col-sm-8 conInfo')
                var imgCol = $('<div>').addClass('col-sm-4 d-flex align-items-center').css('height', '111px')
                var calendar = $('<img>').attr('src', "open-iconic-master/svg/calendar.svg")
                var pin = $('<img>').attr('src', 'open-iconic-master/svg/location.svg')
                var dollar = $('<img>').attr('src', 'open-iconic-master/svg/dollar.svg')

                date.prepend(calendar)
                venue.prepend(pin)
                ticketRange.prepend(dollar)
                imgCol.append(imgDiv)

                if (i % 2 === 0) {
                    row.css('background-color', 'lightsteelblue')
                }
                else {
                    row.css('background-color', 'lightgray')
                }
                col.append(title, date, venue, ticketRange)
                row.append(imgCol, col)
                $('#results-col').append(row)

                row.hover((function (marker, i) {
                    return function () {
                        marker.setAnimation(google.maps.Animation.BOUNCE);
                    }
                })(marker, i), function (marker, i) {
                    return function () {
                        marker.setAnimation(null);
                    }
                }(marker, i));

                i++


            });


            if (events.length <= 2) {
                var location = events[0]._embedded.venues['0'].location
                console.log(location.latitude)
                var myLatLng = { lat: parseFloat(location.latitude), lng: parseFloat(location.longitude) };
                map = new google.maps.Map(document.getElementById('map'), {
                    center: myLatLng,
                    zoom: 11
                });


                events.forEach(element => {
                    var name = element.name
                    var location = element._embedded.venues['0'].location
                    marker = new google.maps.Marker({
                        position: new google.maps.LatLng(location.latitude, location.longitude),
                        map: map
                    })
                    bounds.extend(marker.position);


                })
            }
            else {
                map.fitBounds(bounds)
            }

        }




        //ajax call to google for lat and long of city


        var destination = localStorage.getItem('locationLocal')
        keyword = localStorage.getItem('band')

        if (destination === '') {
            var baseUrl = 'https://app.ticketmaster.com/discovery/v2/events?apikey=yEtBYAcCK5MzWmE1UdE1NUheV74fQK8H&classificationName=Music'
            var queryUrl = baseUrl + '&keyword=' + keyword + '&radius=50'

            $.ajax({
                url: queryUrl,
                method: 'GET'
            }).then(function (response) {

                var events = response._embedded.events

                //sorts events by date
                events.sort(function (a, b) {
                    return Date.parse(a.dates.start.localDate) - Date.parse(b.dates.start.localDate)
                })

                console.log(events)
                var marker
                addMarkers(events)

            })
        }
        else {

            $.ajax({
                url: 'https://maps.googleapis.com/maps/api/geocode/json?address=' + destination + '&key=AIzaSyCXtwNcWQKwMAYBw-2F4T4FRAwWqj39dJE',
                method: 'GET'
            }).then(function (response) {
                var latlong = response.results[0].geometry.location
                latitude = latlong.lat
                longitude = latlong.lng
                var baseUrl = 'https://app.ticketmaster.com/discovery/v2/events?apikey=yEtBYAcCK5MzWmE1UdE1NUheV74fQK8H&classificationName=Music'
                var queryUrl = baseUrl + '&keyword=' + keyword + '&radius=50' + '&latlong=' + latitude + ',' + longitude

                console.log(response)
                //ajax call for ticketmaster
                $.ajax({
                    url: queryUrl,
                    method: 'GET'
                }).then(function (response) {

                    var events = response._embedded.events

                    //sorts events by date
                    events.sort(function (a, b) {
                        return Date.parse(a.dates.start.localDate) - Date.parse(b.dates.start.localDate)
                    })

                    console.log(events)
                    var marker
                    addMarkers(events)

                })
            })
        }


    </script>

</body>

</html>