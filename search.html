<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>iConcert | Results</title>
    <link rel="icon" type="image/png" href="assets/images/bumperBG.jpg" sizes="16x16" />
    <link href="https://fonts.googleapis.com/css?family=Baloo+Tammudu" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel='stylesheet' href='assets/css/search.css'>
    <script src='assets/javascript/hotels.js'></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXtwNcWQKwMAYBw-2F4T4FRAwWqj39dJE"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&v=3&libraries=geometry"></script>

</head>
<header>
    <div id="headTitle">
        <h1>iConcert</h1>
    </div>
</header>


<body>
    <!-- <div class="container resultOverlay"> -->
    <div class="row form-row searchBox">
        <div class="col-sm-3">
            <input class="form-group form-control form-control-sm align-middle locationInput" type="text" placeholder="By Location ...">
        </div>
        <div class="col-sm-3">
            <input class="form-group form-control form-control-sm align-middle bandInput" type="text" placeholder="By Band/Genre ...">
        </div>
        <div class="col-sm-2">
            <select class="form-group form-control form-control-sm align-middle dateFromSelect">
                <option>Date From: </option>
            </select>
        </div>
        <div class="col-sm-2">
            <select class="form-group form-control form-control-sm align-middle dateToSelect">
                <option>Date To: </option>
            </select>
        </div>
        <div class="col-sm-2">
            <button type="submit" class="form-group btn btn-primary btn-sm btn-dark submitForm">Submit</button>
        </div>
    </div>

    <div class='container-fluid' id='map'> </div>
    <button id='shrink'>shrink</button>
    <div class='container' id='results-col'> </div>
    <div class='container' id='info'>
        <button id='back' class='btn btn-primary'>Back to Results</button>


    </div>

    <!--
        ---------------------------------------------------------------------------------------------

        So the footer below is setup, but is just waiting on some text input before it can fully build the itself.

        var for the div to set up the cost formula  - .totalCost

        _____________________________________________________________________________________________
     -->

    <div id="footer" class="row">
        <div class="col-sm-12">
            <div class="totalCost"></div>
        </div>
    </div>


    <!-- </div> -->




    <script>
        var venueMarkers = []
        var currentVenue = []
        var currentHotels = []

        // Causes results to be pushed off screen or come back on
        $('#shrink').click(function () {
            if ($('#shrink').text() === 'shrink') {
                $('.container').css('left', '-408px')
                $('#shrink').css('left', '0')
                $('#shrink').text('grow')
                $('.container-fluid').css('width', '100%').css('left', '0%')
            }
            else {
                $('.container').css('left', '0')
                $('#shrink').css('left', '408px')
                $('#shrink').text('shrink')
                $('.container-fluid').css('width', '70%').css('left', '408px')
            }



        })

        // Causes the info page to show
        $(document).on('click', '.row', function () {
            $('#info').css('z-index', '1000')
            var img = $('<img>')
            img.attr('src', $(this).children('.col-sm-4').children().attr('src')).css('width', '100%')
            $('#info').append(img)

            var row = $(this)
            var title = $('<h3>').text(row.children('.col-sm-8').children('.title').text())
            $('#info').append(title)

            var location = JSON.parse(this.dataset.location)
            hotelSearch(location)

        })


        //Causes the results page to show

        $(document).on('click', '#back', function () {
            $('#info').css('z-index', '-1')
            currentVenue[0].setMap(null)
            for (var i = 0; i < venueMarkers.length; i++) {
                venueMarkers[i].setMap(map);
            }

            for (var i = 0; i < currentHotels.length; i++) {
                currentHotels[i].setMap(null);
            }

            currentVenue.forEach(element => {
                element.setMap(null)
            })

            currentVenue = []
            currentHotels = []
            map.fitBounds(bounds)



        })



        // creates map
        var map = new google.maps.Map(document.getElementById('map'), {
        });

        //creates bounds for maps

        var bounds = new google.maps.LatLngBounds();

        function addMarkers(events) {

            var i = 1
            events.forEach(element => {
                var location = element._embedded.venues['0'].location
                var name = element.name
                marker = new google.maps.Marker({
                    position: new google.maps.LatLng(location.latitude, location.longitude),
                    map: map,
                    url: '#' + i
                })
                google.maps.event.addListener(marker, 'click', function () {
                    $([document.documentElement, document.body]).animate({
                        scrollTop: $(".container").offset().top
                    }, 2000);;
                });
                bounds.extend(marker.position);

                venueMarkers.push(marker)
                if (element.dates.start.localTime !== undefined) {
                    var hour = element.dates.start.localTime.slice(0, 2)
                    var min = element.dates.start.localTime.slice(2, 5)
                    if (parseInt(hour) > 12) {
                        hour = parseInt(hour) - 12
                        min += ' PM'
                    }
                    else if (parseInt(hour) === 12) {
                        min += ' PM'
                    }
                    else {
                        min += ' AM'
                    }

                }
                else {
                    var hour = 'TBA'
                    var min = ''
                }



                // Adds results 
                var title = $('<h4>').text(element.name).css('text-align', 'center').addClass('title')
                var date = $('<p>').text('   ' + element.dates.start.localDate).addClass('date')
                var time = $('<p>').text('Start Time: ' + hour + min).addClass('time')
                var img = $('<img>').attr('src', element.images[7].url).css('width', '100px').css('display', 'block').css('height','100px').css('margin', '0 auto').css('border-radius','100px')
                var row = $('<div>').addClass('row border').attr('data-location', JSON.stringify(element._embedded.venues['0'].location))
                var col = $('<div>').addClass('col-sm-8')
                var imgCol = $('<div>').addClass('col-sm-4 d-flex align-items-center').css('height', '111px')
                var calendar = $('<img>').attr('src',"open-iconic-master/svg/calendar.svg")
                
                date.prepend(calendar)
                imgCol.append(img)

                if (i % 2 === 0) {
                    row.css('background-color', 'lightgrey')
                }
                else {
                    row.css('background-color', 'lemonchiffon')
                }
                col.append(title, date, time)
                row.append(imgCol,col)
                $('#results-col').append(row)

                row.hover((function (marker, i) {
                    return function () {
                        marker.setAnimation(google.maps.Animation.BOUNCE);
                    }
                })(marker, i), function (marker, i) {
                    return function () {
                        marker.setAnimation(null);
                    }
                }(marker, i));

                i++


            });


            if (events.length <= 2) {
                var location = events[0]._embedded.venues['0'].location
                console.log(location.latitude)
                var myLatLng = { lat: parseFloat(location.latitude), lng: parseFloat(location.longitude) };
                map = new google.maps.Map(document.getElementById('map'), {
                    center: myLatLng,
                    zoom: 11
                });


                events.forEach(element => {
                    var name = element.name
                    var location = element._embedded.venues['0'].location
                    marker = new google.maps.Marker({
                        position: new google.maps.LatLng(location.latitude, location.longitude),
                        map: map
                    })
                    bounds.extend(marker.position);


                })
            }
            else {
                map.fitBounds(bounds)
            }

        }




        //ajax call to google for lat and long of city

        $.ajax({
            url: 'https://maps.googleapis.com/maps/api/geocode/json?address=los angeles&key=AIzaSyCXtwNcWQKwMAYBw-2F4T4FRAwWqj39dJE',
            method: 'GET'
        }).then(function (response) {
            var latlong = response.results[0].geometry.location
            var latitude = latlong.lat
            var longitude = latlong.lng
            var baseUrl = 'https://app.ticketmaster.com/discovery/v2/events?apikey=yEtBYAcCK5MzWmE1UdE1NUheV74fQK8H&classificationName=Music'
            var destination
            var keyword = 'fleetwood mac'
            var queryUrl = baseUrl + '&keyword=' + keyword + '&radius=50' 


            //ajax call for ticketmaster
            $.ajax({
                url: queryUrl,
                method: 'GET'
            }).then(function (response) {
                console.log(response)
                var events = response._embedded.events
                //sorts events by date
                events.sort(function (a, b) {
                    return Date.parse(a.dates.start.localDate) - Date.parse(b.dates.start.localDate)
                })




                console.log(events)
                var marker
                addMarkers(events)

            })
        })



    </script>

</body>

</html>